#!/bin/bash

apt-get update && apt-get install -y python-pip redis-server python-dev python-virtualenv libffi-dev libssl-dev haproxy
mkdir /opt
virtualenv /opt/mcloud
/opt/mcloud/bin/pip install mcloud
ln -s /opt/mcloud/bin/mcloud* /usr/local/bin/
ln -s /opt/mcloud/bin/pip /usr/local/bin/mcloud-pip

cat << EOF > /etc/init/mcloud.conf
description "mflcoud service"
author "Me"
start on filesystem and started docker
stop on runlevel [!2345]
respawn

script
  exec /opt/mcloud/bin/mcloud-rpc-server --haproxy  >> /var/log/mcloud.log 2>&1
end script


pre-start script
# Date format same as (new Date()).toISOString() for consistency
echo "[`date -u +%Y-%m-%dT%T.%3NZ`] (sys) Starting" >> /var/log/mcloud.log
end script

pre-stop script
echo "[`date -u +%Y-%m-%dT%T.%3NZ`] (sys) Stopping" >> /var/log/mcloud.log
end script

EOF
